<html>
  <head>
    <link href="theme.css" rel="stylesheet" type="text/css"> 
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js' type='text/javascript'></script> 
  </head>
  <body>

    <div id="hud">
      <div id="note">Loading...</div>
    </div>
    <a class="config" href="config.html">Edit NewRelic API key</a>.

    <script>
      var api_endpoint = "https://rpm.newrelic.com/";
      var newrelic_api_key = localStorage["newrelic_api_key"];

          /* TODO: is there a preferred app selected?
           * TODO: fetch Apdex here:
           */
          var parsed_apdex = "1.0"; // FIXME
          chrome.browserAction.setBadgeText( {text:parsed_apdex} );
          var apdex_colors = {
            safe:  [0,    0,  255,  225],
            danger:[255,  0,  0,    255]
          };

          /* RGBA order */
          chrome.browserAction.setBadgeBackgroundColor(
            {color:apdex_colors.safe}
          );

      if( newrelic_api_key ) {

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function( x ) {
          if( xhr.readyState != 4 )
            return;
          if( xhr.status != 200 ) {
            console.log( "error! - " + xhr.status );
            return;
          }

          $("#hud").empty();
          $("#hud").append( xhr.responseText );
        }
        xhr.open("GET", api_endpoint + "application_dashboard", true);
        xhr.setRequestHeader("x-api-key", newrelic_api_key);
        xhr.send();
      } else {
        $("#note").css("border", "5px solid red;");
        $("#note").replaceWith("<h1>First, enter your NewRelic API key.</h1>");
      }

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-228926-7']);
      _gaq.push(['_setCampNameKey',   'version-1']);
      _gaq.push(['_setCampMediumKey', 'google-chrome']);
      _gaq.push(['_setCampSourceKey', 'chrome-relic-extension']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>

  </body>
</html>
